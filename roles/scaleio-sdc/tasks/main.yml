---
- include: ../../scaleio-common/tasks/install_scaleio.yml

- name: Ubuntu Trusty minimum kernel version
  apt:
    name: '{{ scaleio_sdc_ubuntu_kernel }}'
  when: ansible_distribution == "Ubuntu"
    and ansible_distribution_release == "trusty"
    and ansible_kernel|version_compare("4.4", "<")
  register: scaleio_sdc_ubuntu_kernel_upgraded

- name: restart machine
  command: shutdown -r now "Ansible updates triggered"
  async: 0
  poll: 0
  sudo: true
  ignore_errors: true
  when: scaleio_sdc_ubuntu_kernel_upgraded|changed

- name: waiting for server to come back
  local_action: wait_for host={{ inventory_hostname }} state=started delay=30 timeout=200
  sudo: false
  when: scaleio_sdc_ubuntu_kernel_upgraded|changed

- name: copy scaleio_sdc_driver_sync_user_private_rsa_key_src for driver_sync.conf
  copy:
    src: "{{ scaleio_sdc_driver_sync_user_private_rsa_key_src }}"
    dest: "{{ scaleio_sdc_driver_sync_user_private_rsa_key_dest }}"
    mode: "0600"
    owner: "root"
    group: "root"
  when: scaleio_sdc_driver_sync_user_private_rsa_key_src is defined

- name: copy scaleio_sdc_driver_sync_repo_public_rsa_key_src for driver_sync.conf
  copy:
    src: "{{ scaleio_sdc_driver_sync_repo_public_rsa_key_src }}"
    dest: "{{ scaleio_sdc_driver_sync_repo_public_rsa_key_dest }}"
    mode: "0600"
    owner: "root"
    group: "root"
  when: scaleio_sdc_driver_sync_repo_public_rsa_key_src is defined

- name: copy scaleio_sdc_driver_sync_emc_public_gpg_key_src for driver_sync.conf
  copy:
    src: "{{ item }}"
    dest: "{{ scaleio_sdc_driver_sync_emc_public_gpg_key_dest }}"
    mode: "0600"
    owner: "root"
    group: "root"
  with_fileglob:
    - "{{ scaleio_sdc_driver_sync_emc_public_gpg_key_src }}"
  when: scaleio_sdc_driver_sync_emc_public_gpg_key_src is defined

- name: copy driver_sync.conf template in place
  template:
    src: "driver_sync.conf.j2"
    dest: "/bin/emc/scaleio/scini_sync/driver_sync.conf"
    mode: "0600"
    owner: "root"
    group: "root"
  notify: restart scini
